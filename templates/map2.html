<!DOCTYPE html>
<html>
  <head>
    <title>The Digital Bushman: Into the Okavango</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    
    <link rel="stylesheet" href="/static/css/leaflet.css" />
    <script src="/static/js/leaflet.js"></script>
	
	<script language="Javascript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

	 <style type="text/css">
		
		iframe { 
			vertical-align: top;
		}
		
		#map_holder{
			position: fixed;
			top: 0px;
			left: 0px;
			width:100%; 
			height:100%;
			z-index: 0;
		}
		
		#map{
			width:100%;
			height:100%; 
			position: "absolute"; 
			top: 0px; 
			left: 0px; 
			overflow: "hidden";
		}

		#holder{
			width: 270px;
			left:50px;
			background: rgba(0,0,0,0.8);
			z-index: 1000;
			position: absolute;
			font: 14px Verdana, Helvetica, sans-serif; 
			color: white;
			padding: 10px;
		}
		
		
		a{
			color: white;
		}
      }
    </style>
  	
	

  </head>
  <body>

	
	<!--Google Maps APIv3 Background-->
	<div id="map_holder">
		<div id="map"></div>
	</div><!-- End Google Maps Background -->

	<div id="holder">
		<a href="#" id="expedition">About the Expedition</a>
		<a href="#" id="api">Public API</a>
		<a href="#" id="help">Help</a>
	</div>	


	<script type="text/javascript">
	  	// create a map in the "map" div, set the view to a given place and zoom
		var map = L.map('map').setView([-19.2571, 22.6560], 5);
		map.zoomAnimationThreshold = 20;

		// add an OpenStreetMap tile layer
		L.tileLayer('http://a.tiles.mapbox.com/v3/brianhouse.map-oxn5wd2a/{z}/{x}/{y}.png', {
		    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);


		var lastPoint;
		var markers = [];
		var beaconMarkers = [];

		var d = new Date();
		var focusMarker;

		var step = -1;

		var scripts = [
			"This is the Okavango Delta.",
			"Located in Botswana, it is one of the richest wildlife areas on the planet.",
			"On September 7th, an expedition led by Dr. Steve Boyes entered the area to explore and survey new parts of the central delta.",
			"On this site, you can follow along with the expedition, and access all of the data they are collecting, including wildlife sightings, colour samples, and position and heartrate data for individual expedition members.",
			"This is the last reported location of the expedition.",
			" Click, drag, and zoom the map to see previous data points. For help & information about the expedition API, click on the help button at the top of the page."
		]

		loadBeacons();

		//DATA LOAD FUNCTIONS
		function loadBeacons() {

			var beaconOptions = {
			    radius: 4,
			    fillColor: "#ff7800",
			    color: "#000",
			    weight: 1,
			    opacity: 0,
			    fillOpacity: 0.8,
			};


			$.getJSON('/api/timeline?date=20130907&types=beacon&days=100', function(data) {
			  L.geoJson(data.features, {
			    filter: function(feature, layer) {
			    	//Filter out 0,0 points
			        return (feature.geometry.coordinates[0] != 0);
			    },
			    pointToLayer: function (feature, latlng) {
			        var marker = L.circleMarker(latlng, beaconOptions);
			        beaconMarkers.push(marker);
			        markers.push(marker)
			        return marker;
			    },
			    style: function(feature) {
			    	//Here we can apply styling to markers depending on properties. Cool.
			    	var c = Math.floor(feature.properties["Speed"] * 4);
			        return {fillColor: "#FFFFFF"};
			    }
				})
			    map.panTo(markers[markers.length - 1].getLatLng());
			    var lm = beaconMarkers[beaconMarkers.length - 1];
				focusMarker = L.marker(lm.getLatLng()).addTo(map);
				nextStep();
			});
		}

		function loadSightings() {

			var sightingOptions = {
			    radius: 2,
			    fillColor: "#ff9900",
			    color: "#000",
			    weight: 1,
			    opacity: 0,
			    fillOpacity: 0.8,
			};

			function onEachFeature(feature, layer) {
			    // does this feature have a property named popupContent?
			    if (feature.properties && feature.properties.Count) {
			        layer.bindPopup(feature.properties.Count + " " + feature.properties["Bird Name"] );
			    }
			}


			$.getJSON('/api/timeline?date=20130907&types=sightings&days=100', function(data) {
			  L.geoJson(data.features, {
			    filter: function(feature, layer) {
			    	//Filter out 0,0 points
			        return (feature.geometry.coordinates[0] != 0);
			    },
			    pointToLayer: function (feature, latlng) {
			        var marker = L.circleMarker(latlng, sightingOptions);
			        markers.push(marker);
			        return marker;
			    },
			    onEachFeature: onEachFeature,
			    style: function(feature) {
			    	//Here we can apply styling to markers depending on properties. Cool.
			    	var c = Math.sqrt(feature.properties["Count"]);
			        return {radius: 2 + c};
			    }
				}).addTo(map);
			});
		}

		function zoomIn() {
			console.log("zoom");
			if (map.getZoom() < 17) map.zoomIn(3);
			if (step < scripts.length) {
				nextStep();
				setTimeout(zoomIn, 8000)
			} else {
				loadSightings();
			}
			
		}

		function nextStep() {
			focusMarker.bindPopup(scripts[step])
			focusMarker.openPopup();
			step ++;
		}

		loadBeacons();

		setTimeout(zoomIn, 5000);

		//Buttons
		/*
		onLoad
		*/
		$(function(){
 
			$("#expedition").click(function(event){
				event.preventDefault(); 
				console.log("expedition");
			});
 
			$("#api").click(function(event){
				event.preventDefault(); 
				window.location = "http://digitalbushman.org/api";
				console.log("API");
			});
 
			$("#help").click(function(event){
				event.preventDefault(); 
				console.log("help");
			});
 
		});


					
	</script>
	
</body>
</html>